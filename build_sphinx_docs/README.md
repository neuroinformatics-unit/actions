# Build Sphinx documentation action
This is a GitHub action that builds Sphinx documentation for your project.

The various steps include:

* setting up Python
  * the version can be specified via the `python-version` input, and defaults to `3.x`
* installing pip and setting up pip cache
* pip installing build dependencies (themes, build tools, etc.) in one of two ways:
  * by default, from `docs/requirements.txt` (with `use-requirements-txt: true`), or
  * from the `[docs]` section of `pyproject.toml` (with `use-requirements-txt: false`) 
* checking that external links in the documentation are not broken
  * optional, defaults to `true` (i.e. links are checked), see the [warning](#warning) below for more information
  * you can pass a GitHub token via the `github-token` input, which is exposed as the `GITHUB_TOKEN` environment variable during linkcheck. This can help avoid rate-limiting when checking links to GitHub repositories.
* building the html pages in one of two ways, by setting the `use-make` input (default: `false`)
  * (default) using `sphinx-build` to build the pages from `docs/source` (should contain Sphinx source files) to `docs/build`
  * (`use-make: true`) using the `make` utility with a custom `docs/Makefile` to build the pages from `SOURCEDIR` to `BUILDDIR` as defined in the Makefile
* uploading the built html pages as an artifact named `docs-build`, for use in other actions
  * by default, the artifact is uploaded using [actions/upload-artifact](https://github.com/actions/upload-artifact)
  * alternatively, if the [artifact.ci](artifact.ci) GitHub app is installed in your repository,
  you can upload the artifact using artifact.ci by setting the `use-artifactci` input to `lazy` or `eager`. By default, it is set to `false` (i.e., the GitHub `upload-artifact` action is used). When either `lazy` or `eager` is used, the URL to the docs preview is printed to the GitHub Actions summary, with a slight difference between them:
      * in `lazy` mode, the docs are only uploaded to artifact.ci when a logged-in user visits the URL. This avoids unnecessary uploads to artifact.ci (e.g. if the action is run on every commit, we may not need to visualise the docs in each of them), but it means waiting for a couple of minutes for the docs to be ready to view.
      * in `eager` mode, the docs are uploaded immediately to the URL every time the action runs. Clicking the URL in the summary will take you directly to the docs preview.

It can be run upon all pull requests, to ensure that documentation still builds.

It does not publish or deploy the documentation in any way (for that, check the [Deploy Sphinx Docs action](../deploy_sphinx_docs/README.md)).

## Warning

You can debug the linkcheck step by running it locally:
```bash
sphinx-build docs/source docs/build -b linkcheck
```
or, if you have `docs/Makefile`:
```bash
cd docs && make linkcheck
```
If the linkcheck step produces "false positives" for your project (i.e. marking valid links as broken), you have two options:

- Adding the following to `conf.py` (replace with the problematic URLs).
  ```python
  # The linkcheck builder will skip verifying that anchors exist when checking 
  # these URLs (e.g. because they are generated by JavaScript).
  linkcheck_anchors_ignore_for_url = [
      "https://gin.g-node.org/G-Node/Info/wiki/",
      "https://neuroinformatics.zulipchat.com/",
  ]
  ```
- Disabling the linkcheck step by setting the `check-links` input to `false`, e.g.:
  ```yaml
  build_sphinx_docs:
    name: Build Sphinx Docs
    runs-on: ubuntu-latest
    steps:
    - uses: neuroinformatics-unit/actions/build_sphinx_docs@main
      with:
        check-links: false
  ```

If the linkcheck step takes too long in CI due to rate-limiting on GitHub URLs, you can pass a GitHub token via the `github-token` input and configure `conf.py` to use it in request headers:
```yaml
build_sphinx_docs:
  name: Build Sphinx Docs
  runs-on: ubuntu-latest
  steps:
  - uses: neuroinformatics-unit/actions/build_sphinx_docs@main
    with:
      github-token: ${{ secrets.GITHUB_TOKEN }}
```
```python
# conf.py
import os

github_token = os.environ.get("GITHUB_TOKEN", "")
linkcheck_request_headers = {
    "https://github.com": {
        "Authorization": f"token {github_token}",
    },
}
```
